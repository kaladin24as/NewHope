"""
Great Expectations Suite Example
Auto-generated by AntiGravity for {{ project_name }}

This suite contains common data quality expectations.
Customize based on your specific data requirements.
"""

import great_expectations as gx
from great_expectations.core.batch import RuntimeBatchRequest


def create_expectation_suite(context, suite_name="{{ project_name }}_quality_suite"):
    """
    Create and return a Great Expectations suite with common validations.
    
    Args:
        context: Great Expectations DataContext
        suite_name: Name of the expectation suite
        
    Returns:
        ExpectationSuite object
    """
    
    # Create or get existing suite
    try:
        suite = context.get_expectation_suite(expectation_suite_name=suite_name)
        print(f"Loaded existing suite: {suite_name}")
    except:
        suite = context.create_expectation_suite(
            expectation_suite_name=suite_name,
            overwrite_existing=True
        )
        print(f"Created new suite: {suite_name}")
    
    # Get validator
    batch_request = RuntimeBatchRequest(
        datasource_name="{{ project_name }}_warehouse",
        data_connector_name="default_runtime_data_connector",
        data_asset_name="sample_table",  # Replace with actual table name
        runtime_parameters={"query": "SELECT * FROM sample_table LIMIT 1000"},
        batch_identifiers={"default_identifier_name": "default_identifier"}
    )
    
    validator = context.get_validator(
        batch_request=batch_request,
        expectation_suite_name=suite_name
    )
    
    # =========================================================================
    # Common Data Quality Expectations
    # =========================================================================
    
    # 1. TABLE-LEVEL EXPECTATIONS
    validator.expect_table_row_count_to_be_between(min_value=1, max_value=None)
    validator.expect_table_columns_to_match_ordered_list(
        column_list=["id", "created_at", "updated_at"]  # Customize
    )
    
    # 2. COLUMN EXISTENCE
    validator.expect_column_to_exist(column="id")
    validator.expect_column_to_exist(column="created_at")
    
    # 3. NULL CHECKS
    validator.expect_column_values_to_not_be_null(column="id")
    validator.expect_column_values_to_not_be_null(column="created_at")
    
    # 4. UNIQUENESS
    validator.expect_column_values_to_be_unique(column="id")
    
    # 5. DATA TYPES
    validator.expect_column_values_to_be_of_type(column="id", type_="INTEGER")
    validator.expect_column_values_to_be_of_type(column="created_at", type_="TIMESTAMP")
    
    # 6. VALUE RANGES (customize based on your data)
    # validator.expect_column_values_to_be_between(
    #     column="age",
    #     min_value=0,
    #     max_value=120
    # )
    
    # 7. CATEGORICAL VALUES
    # validator.expect_column_values_to_be_in_set(
    #     column="status",
    #     value_set=["active", "inactive", "pending"]
    # )
    
    # 8. REGEX PATTERNS
    # validator.expect_column_values_to_match_regex(
    #     column="email",
    #     regex="^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$"
    # )
    
    # 9. FRESHNESS (for timestamp columns)
    # from datetime import datetime, timedelta
    # max_age_hours = 24
    # validator.expect_column_max_to_be_between(
    #     column="created_at",
    #     min_value=(datetime.now() - timedelta(hours=max_age_hours)).isoformat(),
    #     max_value=datetime.now().isoformat()
    # )
    
    # 10. REFERENTIAL INTEGRITY (if you have foreign keys)
    # validator.expect_column_values_to_be_in_set(
    #     column="user_id",
    #     value_set=context.get_validator(...).expect_column_distinct_values_to_be_in_set(...)
    # )
    
    # Save expectation suite
    validator.save_expectation_suite(discard_failed_expectations=False)
    
    print(f"Suite '{suite_name}' saved with {len(validator.get_expectation_suite().expectations)} expectations")
    
    return suite


if __name__ == "__main__":
    # Initialize Great Expectations context
    context = gx.get_context()
    
    # Create suite
    suite = create_expectation_suite(context)
    
    print("âœ… Expectation suite created successfully!")
    print(f"View Data Docs at: file://uncommitted/data_docs/local_site/index.html")
