# Prometheus Alerting Rules for Data Pipelines
# Auto-generated by AntiGravity for {{ project_name }}

groups:
  # ==========================================================================
  # Infrastructure Alerts
  # ==========================================================================
  
  - name: infrastructure
    interval: 30s
    rules:
      - alert: HighCPUUsage
        expr: rate(container_cpu_usage_seconds_total{container=~"{{ project_name }}_.*"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "High CPU usage detected"
          description: "Container {{ "{{" }} $labels.container {{ "}}" }} CPU usage is above 80% for 5 minutes"
      
      - alert: HighMemoryUsage
        expr: (container_memory_usage_bytes{container=~"{{ project_name }}.*"} / container_spec_memory_limit_bytes{container=~"{{ project_name }}_.*"}) > 0.9
        for: 5m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "High memory usage detected"
          description: "Container {{ "{{" }} $labels.container {{ "}}" }} memory usage is above 90%"
      
      - alert: ContainerDown
        expr: up{job=~"{{ project_name }}_.*"} == 0
        for: 1m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "Container is down"
          description: "Container {{ "{{" }} $labels.job {{ "}}" }} has been down for 1 minute"

{% if stack.storage == 'PostgreSQL' %}
  # ==========================================================================
  # PostgreSQL Database Alerts
  # ==========================================================================
  
  - name: postgresql
    interval: 30s
    rules:
      - alert: PostgreSQLDown
        expr: pg_up{database="{{ project_name }}_warehouse"} == 0
        for: 1m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL database has been down for 1 minute"
      
      - alert: PostgreSQLTooManyConnections
        expr: pg_stat_database_numbackends{datname="{{ project_name }}_warehouse"} > pg_settings_max_connections * 0.8
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "PostgreSQL too many connections"
          description: "PostgreSQL connections at {{ "{{" }} $value {{ "}}" }}% of max"
      
      - alert: PostgreSQLDeadlocks
        expr: rate(pg_stat_database_deadlocks{datname="{{ project_name }}_warehouse"}[5m]) > 0
        for: 1m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "PostgreSQL deadlocks detected"
          description: "PostgreSQL has {{ "{{" }} $value {{ "}}" }} deadlocks per second"
      
      - alert: PostgreSQLSlowQueries
        expr: pg_stat_activity_max_tx_duration{datname="{{ project_name }}_warehouse"} > 300
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "PostgreSQL slow queries"
          description: "Queries running longer than 5 minutes detected"
{% endif %}

{% if stack.orchestration == 'Airflow' %}
  # ==========================================================================
  # Airflow Pipeline Alerts
  # ==========================================================================
  
  - name: airflow
    interval: 60s
    rules:
      - alert: AirflowSchedulerDown
        expr: up{job="airflow-scheduler"} == 0
        for: 2m
        labels:
          severity: critical
          component: orchestration
        annotations:
          summary: "Airflow scheduler is down"
          description: "Airflow scheduler has been down for 2 minutes"
      
      - alert: AirflowTaskFailures
        expr: rate(airflow_task_failed_total[1h]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: orchestration
        annotations:
          summary: "High Airflow task failure rate"
          description: "Task failure rate is {{ "{{" }} $value {{ "}}" }} per second"
      
      - alert: AirflowTaskQueueSize
        expr: airflow_task_queued_total > 100
        for: 10m
        labels:
          severity: warning
          component: orchestration
        annotations:
          summary: "Airflow task queue is large"
          description: "{{ "{{" }} $value {{ "}}" }} tasks queued, possible scheduling issues"
{% endif %}

  # ==========================================================================
  # Data Pipeline Alerts
  # ==========================================================================
  
  - name: data_pipelines
    interval: 60s
    rules:
      - alert: DataPipelineStale
        expr: (time() - pipeline_last_success_timestamp_seconds) > 7200
        for: 5m
        labels:
          severity: warning
          component: pipeline
        annotations:
          summary: "Data pipeline is stale"
          description: "Pipeline {{ "{{" }} $labels.pipeline_name {{ "}}" }} hasn't succeeded in 2+ hours"
      
      - alert: DataQualityFailure
        expr: data_quality_check_failed_total > 0
        for: 1m
        labels:
          severity: critical
          component: quality
        annotations:
          summary: "Data quality checks failed"
          description: "{{ "{{" }} $value {{ "}}" }} data quality checks have failed"
      
      - alert: DataFreshnessIssue
        expr: (time() - data_last_update_timestamp_seconds) > 86400
        for: 1h
        labels:
          severity: warning
          component: data
        annotations:
          summary: "Data freshness issue"
          description: "Table {{ "{{" }} $labels.table_name {{ "}}" }} hasn't been updated in 24+ hours"

  # ==========================================================================
  # Disk Space Alerts
  # ==========================================================================
  
  - name: disk_space
    interval: 60s
    rules:
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.15
        for: 5m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "Disk space is low"
          description: "Less than 15% disk space remaining"
      
      - alert: DiskSpaceCritical
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.05
        for: 1m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "Disk space is critical"
          description: "Less than 5% disk space remaining - immediate action required"
