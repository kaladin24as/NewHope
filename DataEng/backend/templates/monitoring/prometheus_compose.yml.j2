# Prometheus & Alertmanager Monitoring Stack
# Auto-generated by AntiGravity for {{ project_name }}

prometheus:
  image: prom/prometheus:v2.48.0
  container_name: {{ project_name }}_prometheus
  hostname: prometheus
  ports:
    - "{{ ports.prometheus }}:9090"
  command:
    - '--config.file=/etc/prometheus/prometheus.yml'
    - '--storage.tsdb.path=/prometheus'
    - '--storage.tsdb.retention.time=30d'
    - '--web.console.libraries=/etc/prometheus/console_libraries'
    - '--web.console.templates=/etc/prometheus/consoles'
    - '--web.enable-lifecycle'
  volumes:
    - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    - ./monitoring/alerts:/etc/prometheus/alerts
    - prometheus-data:/prometheus
  networks:
    - {{ project_name }}_net
  depends_on:
    - alertmanager
{% if stack.storage == 'PostgreSQL' %}
    - postgres_exporter
{% endif %}
  healthcheck:
    test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 30s
  restart: unless-stopped

alertmanager:
  image: prom/alertmanager:v0.26.0
  container_name: {{ project_name }}_alertmanager
  hostname: alertmanager
  ports:
    - "{{ ports.alertmanager }}:9093"
  command:
    - '--config.file=/etc/alertmanager/config.yml'
    - '--storage.path=/alertmanager'
  volumes:
    - ./monitoring/alertmanager.yml:/etc/alertmanager/config.yml
    - alertmanager-data:/alertmanager
  networks:
    - {{ project_name }}_net
  healthcheck:
    test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
    interval: 30s
    timeout: 10s
    retries: 3
  restart: unless-stopped

{% if stack.storage == 'PostgreSQL' %}
postgres_exporter:
  image: prometheuscommunity/postgres-exporter:v0.15.0
  container_name: {{ project_name }}_postgres_exporter
  hostname: postgres_exporter
  environment:
    DATA_SOURCE_NAME: postgresql://{{ secrets.postgres_user }}:{{ secrets.postgres_password }}@postgres:5432/{{ project_name }}_warehouse?sslmode=disable
  networks:
    - {{ project_name }}_net
  depends_on:
    postgres:
      condition: service_healthy
  restart: unless-stopped
{% endif %}

node_exporter:
  image: prom/node-exporter:v1.7.0
  container_name: {{ project_name }}_node_exporter
  hostname: node_exporter
  command:
    - '--path.procfs=/host/proc'
    - '--path.sysfs=/host/sys'
    - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
  volumes:
    - /proc:/host/proc:ro
    - /sys:/host/sys:ro
    - /:/rootfs:ro
  networks:
    - {{ project_name }}_net
  restart: unless-stopped

cadvisor:
  image: gcr.io/cadvisor/cadvisor:v0.47.0
  container_name: {{ project_name }}_cadvisor
  hostname: cadvisor
  privileged: true
  devices:
    - /dev/kmsg:/dev/kmsg
  volumes:
    - /:/rootfs:ro
    - /var/run:/var/run:ro
    - /sys:/sys:ro
    - /var/lib/docker:/var/lib/docker:ro
    - /cgroup:/cgroup:ro
  networks:
    - {{ project_name }}_net
  restart: unless-stopped
