# Prometheus Configuration
# Auto-generated by AntiGravity for {{ project_name }}

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: '{{ project_name }}'
    environment: 'production'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Load rules once and periodically evaluate them
rule_files:
  - "/etc/prometheus/alerts/*.yml"

# Scrape configurations
scrape_configs:
  # Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Node Exporter (system metrics)
  - job_name: 'node_exporter'
    static_configs:
      - targets: ['node_exporter:9100']
        labels:
          instance: '{{ project_name }}_host'

  # cAdvisor (container metrics)
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']

{% if stack.storage == 'PostgreSQL' %}
  # PostgreSQL Exporter
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres_exporter:9187']
        labels:
          database: '{{ project_name }}_warehouse'
{% endif %}

{% if stack.orchestration == 'Airflow' %}
  # Airflow Metrics (if StatsD enabled)
  - job_name: 'airflow'
    static_configs:
      - targets: ['airflow-webserver:8080']
    metrics_path: '/admin/metrics'
    basic_auth:
      username: 'admin'
      password: '{{ secrets.airflow_admin_password }}'
{% endif %}

{% if 'Grafana' in (stack.visualization | default('')) %}
  # Grafana Metrics
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
    metrics_path: '/metrics'
{% endif %}

  # Service Discovery for Docker containers (optional)
  # - job_name: 'docker'
  #   docker_sd_configs:
  #     - host: unix:///var/run/docker.sock
  #   relabel_configs:
  #     - source_labels: [__meta_docker_container_name]
  #       target_label: container

---
# Alertmanager Configuration
# File: alertmanager.yml

global:
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'
  routes:
    - match:
        severity: critical
      receiver: 'critical'
      continue: true
    - match:
        severity: warning
      receiver: 'warning'

receivers:
  - name: 'default'
    # Configure your notification channels here
    # webhook_configs:
    #   - url: 'http://your-webhook-url'

  - name: 'critical'
    # Example: Slack critical alerts
    # slack_configs:
    #   - api_url: '{{ secrets.slack_webhook_url }}'
    #     channel: '#data-alerts-critical'
    #     title: 'üö® Critical Alert: {{ "{{" }} .GroupLabels.alertname {{ "}}" }}'
    #     text: '{{ "{{" }} range .Alerts {{ "}}" }}{{ "{{" }} .Annotations.description {{ "}}" }}{{ "{{" }} end {{ "}}" }}'
    
    # Example: Email critical alerts
    # email_configs:
    #   - to: 'data-team@{{ project_name }}.com'
    #     from: 'alerts@{{ project_name }}.com'
    #     smarthost: 'smtp.gmail.com:587'
    #     auth_username: '{{ secrets.smtp_user }}'
    #     auth_password: '{{ secrets.smtp_password }}'

  - name: 'warning'
    # Example: Slack warnings
    # slack_configs:
    #   - api_url: '{{ secrets.slack_webhook_url }}'
    #     channel: '#data-alerts'
    #     title: '‚ö†Ô∏è Warning: {{ "{{" }} .GroupLabels.alertname {{ "}}" }}'

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'cluster', 'service']
