# Grafana Visualization Platform
# Auto-generated by AntiGravity

grafana:
  image: grafana/grafana:10.2.0
  container_name: {{ project_name }}_grafana_viz
  hostname: grafana
  ports:
    - "{{ ports.grafana }}:3000"
  environment:
    GF_SECURITY_ADMIN_USER: admin
    GF_SECURITY_ADMIN_PASSWORD: {{ secrets.grafana_admin_password }}
    GF_SERVER_ROOT_URL: http://localhost:{{ ports.grafana }}
    GF_INSTALL_PLUGINS: grafana-postgresql-datasource,grafana-piechart-panel
    GF_AUTH_ANONYMOUS_ENABLED: "false"
    GF_USERS_ALLOW_SIGN_UP: "false"
{% if stack.storage == 'PostgreSQL' %}
    # PostgreSQL datasource auto-provisioning
    GF_DATABASE_TYPE: postgres
    GF_DATABASE_HOST: postgres:5432
    GF_DATABASE_NAME: {{ project_name }}_warehouse
    GF_DATABASE_USER: {{ secrets.postgres_user }}
    GF_DATABASE_PASSWORD: {{ secrets.postgres_password }}
{% endif %}
  volumes:
    - grafana-viz-data:/var/lib/grafana
    - ./grafana/provisioning:/etc/grafana/provisioning
    - ./grafana/dashboards:/var/lib/grafana/dashboards
  networks:
    - {{ project_name }}_net
{% if stack.storage == 'PostgreSQL' %}
  depends_on:
    postgres:
      condition: service_healthy
{% endif %}
  healthcheck:
    test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 30s
  restart: unless-stopped
  user: "472"
