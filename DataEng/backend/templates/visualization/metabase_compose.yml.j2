# Metabase BI Platform Service
# Auto-generated by AntiGravity

metabase:
  image: metabase/metabase:v0.48
  container_name: {{ project_name }}_metabase
  hostname: metabase
  ports:
    - "{{ ports.metabase }}:3000"
  environment:
    MB_DB_TYPE: postgres
    MB_DB_DBNAME: metabase
    MB_DB_PORT: 5432
    MB_DB_USER: {{ project_name }}_metabase_user
    MB_DB_PASS: {{ secrets.metabase_db_password }}
    MB_DB_HOST: metabase_postgres
    MB_ENCRYPTION_SECRET_KEY: {{ secrets.metabase_encryption_key }}
    JAVA_OPTS: "-Xmx2g"
  volumes:
    - metabase-data:/metabase-data
  networks:
    - {{ project_name }}_net
  depends_on:
    metabase_postgres:
      condition: service_healthy
{% if stack.storage == 'PostgreSQL' %}
    postgres:
      condition: service_healthy
{% endif %}
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
    interval: 30s
    timeout: 10s
    retries: 5
    start_period: 60s
  restart: unless-stopped

metabase_postgres:
  image: postgres:15-alpine
  container_name: {{ project_name }}_metabase_postgres
  hostname: metabase_postgres
  environment:
    POSTGRES_DB: metabase
    POSTGRES_USER: {{ project_name }}_metabase_user
    POSTGRES_PASSWORD: {{ secrets.metabase_db_password }}
  volumes:
    - metabase-postgres-data:/var/lib/postgresql/data
  networks:
    - {{ project_name }}_net
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U {{ project_name }}_metabase_user -d metabase"]
    interval: 10s
    timeout: 5s
    retries: 5
  restart: unless-stopped
