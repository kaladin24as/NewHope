# Apache Superset BI Platform
# Auto-generated by AntiGravity

superset:
  image: apache/superset:3.0.0
  container_name: {{ project_name }}_superset
  hostname: superset
  ports:
    - "{{ ports.superset }}:8088"
  environment:
    SUPERSET_SECRET_KEY: {{ secrets.superset_secret_key }}
    SUPERSET_ENV: production
    DATABASE_DIALECT: postgresql
    DATABASE_HOST: superset_postgres
    DATABASE_PORT: 5432
    DATABASE_DB: superset
    DATABASE_USER: {{ project_name }}_superset_user
    DATABASE_PASSWORD: {{ secrets.superset_db_password }}
    REDIS_HOST: superset_redis
    REDIS_PORT: 6379
{% if stack.storage == 'PostgreSQL' %}
    # Main data warehouse connection
    DATA_WAREHOUSE_HOST: postgres
    DATA_WAREHOUSE_PORT: 5432
    DATA_WAREHOUSE_DB: {{ project_name }}_warehouse
    DATA_WAREHOUSE_USER: {{ secrets.postgres_user }}
    DATA_WAREHOUSE_PASSWORD: {{ secrets.postgres_password }}
{% elif stack.storage == 'Snowflake' %}
    SNOWFLAKE_ACCOUNT: {{ secrets.snowflake_account }}
    SNOWFLAKE_USER: {{ secrets.snowflake_user }}
    SNOWFLAKE_PASSWORD: {{ secrets.snowflake_password }}
    SNOWFLAKE_WAREHOUSE: {{ secrets.snowflake_warehouse }}
{% endif %}
  volumes:
    - superset-data:/app/superset_home
  networks:
    - {{ project_name }}_net
  depends_on:
    superset_postgres:
      condition: service_healthy
    superset_redis:
      condition: service_healthy
  command: >
    sh -c "
    superset db upgrade &&
    superset fab create-admin --username admin --firstname Admin --lastname User --email admin@{{ project_name }}.local --password {{ secrets.superset_admin_password }} || true &&
    superset init &&
    superset run -h 0.0.0.0 -p 8088 --with-threads --reload
    "
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
    interval: 30s
    timeout: 10s
    retries: 5
    start_period: 90s
  restart: unless-stopped

superset_postgres:
  image: postgres:15-alpine
  container_name: {{ project_name }}_superset_postgres
  hostname: superset_postgres
  environment:
    POSTGRES_DB: superset
    POSTGRES_USER: {{ project_name }}_superset_user
    POSTGRES_PASSWORD: {{ secrets.superset_db_password }}
  volumes:
    - superset-postgres-data:/var/lib/postgresql/data
  networks:
    - {{ project_name }}_net
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U {{ project_name }}_superset_user -d superset"]
    interval: 10s
    timeout: 5s
    retries: 5
  restart: unless-stopped

superset_redis:
  image: redis:7-alpine
  container_name: {{ project_name }}_superset_redis
  hostname: superset_redis
  volumes:
    - superset-redis-data:/data
  networks:
    - {{ project_name }}_net
  healthcheck:
    test: ["CMD", "redis-cli", "ping"]
    interval: 10s
    timeout: 5s
    retries: 5
  restart: unless-stopped
